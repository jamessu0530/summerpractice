<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>基隆景點瀏覽器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body { padding-bottom: 48px; }
      .zone-btn { min-width: 100px; }
      .card-img-top { object-fit: cover; height: 180px; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="#">基隆景點瀏覽器</a>
      </div>
    </nav>

    <main class="container my-4">
      <div class="mb-3">
        <h5 class="mb-3">請選擇行政區</h5>
        <div class="d-grid d-sm-flex gap-2 flex-wrap">
          <button class="btn btn-outline-primary zone-btn" data-zone="中山">中山區</button>
          <button class="btn btn-outline-primary zone-btn" data-zone="信義">信義區</button>
          <button class="btn btn-outline-primary zone-btn" data-zone="仁愛">仁愛區</button>
          <button class="btn btn-outline-primary zone-btn" data-zone="中正">中正區</button>
          <button class="btn btn-outline-primary zone-btn" data-zone="安樂">安樂區</button>
          <button class="btn btn-outline-primary zone-btn" data-zone="七堵">七堵區</button>
          <button class="btn btn-outline-primary zone-btn" data-zone="暖暖">暖暖區</button>
        </div>
      </div>

      <div id="status" class="my-3" aria-live="polite"></div>

      <div id="cards" class="row row-cols-1 row-cols-md-3 g-4"></div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const statusEl = document.getElementById('status');
      const cardsEl = document.getElementById('cards');

      function setStatus(html) {
        statusEl.innerHTML = html || '';
      }

      function clearCards() {
        cardsEl.innerHTML = '';
      }

      function googleMapsLink(address) {
        const base = 'https://www.google.com/maps/search/?api=1&query=';
        return base + encodeURIComponent(address || '基隆市');
      }

      function renderCards(sights) {
        clearCards();
        if (!Array.isArray(sights) || sights.length === 0) {
          cardsEl.innerHTML = '<div class="col"><div class="alert alert-info">沒有資料</div></div>';
          return;
        }
        const frag = document.createDocumentFragment();
        sights.forEach((sight, idx) => {
          const col = document.createElement('div');
          col.className = 'col';
          const collapseId = `collapse-${idx}`;
          col.innerHTML = `
            <div class="card h-100 shadow-sm">
              ${sight.photoURL ? `<img src="${sight.photoURL}" class="card-img-top" alt="${sight.sightName || ''}">` : ''}
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${sight.sightName || ''}</h5>
                <p class="card-text mb-1"><span class="badge text-bg-secondary me-2">區域</span>${sight.zone || ''}</p>
                <p class="card-text mb-3"><span class="badge text-bg-info me-2">分類</span>${sight.category || ''}</p>
                <div class="mt-auto d-flex gap-2 flex-wrap">
                  <a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="${googleMapsLink(sight.address)}">地址</a>
                  <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">詳細資訊</button>
                </div>
                <div class="collapse mt-3" id="${collapseId}">
                  ${sight.photoURL ? `<img src="${sight.photoURL}" class="img-fluid rounded mb-2" alt="${sight.sightName || ''}">` : ''}
                  <p class="card-text">${sight.description || ''}</p>
                </div>
              </div>
            </div>`;
          frag.appendChild(col);
        });
        cardsEl.appendChild(frag);
      }

      async function loadSights(zone) {
        try {
          setStatus(`<div class="alert alert-secondary">讀取中：${zone}...</div>`);
          clearCards();
          const resp = await fetch(`/SightAPI?zone=${encodeURIComponent(zone)}`);
          if (!resp.ok) {
            if (resp.status === 404) {
              setStatus(`<div class="alert alert-warning">找不到該行政區：${zone}</div>`);
            } else {
              setStatus(`<div class="alert alert-danger">發生錯誤（${resp.status}）</div>`);
            }
            return;
          }
          const data = await resp.json();
          setStatus('');
          renderCards(data);
        } catch (err) {
          console.error(err);
          setStatus('<div class="alert alert-danger">讀取失敗，請稍後再試。</div>');
        }
      }

      // 綁定按鈕事件
      document.querySelectorAll('.zone-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const zone = btn.getAttribute('data-zone');
          loadSights(zone);
        });
      });

      // 可選：預設載入某一區（例如七堵）
      // loadSights('七堵');
    </script>
  </body>
  </html>

